From baa382248109bde17ea9174d5dab5bf2b09eba29 Mon Sep 17 00:00:00 2001
From: Francois Perrad <francois.perrad@gadz.org>
Date: Wed, 18 Jun 2025 01:00:08 +0200
Subject: [PATCH 4/4] split with picol.h

Signed-off-by: Francois Perrad <francois.perrad@gadz.org>
---
 picol.c | 29 +---------------------
 picol.h | 77 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 2 files changed, 78 insertions(+), 28 deletions(-)
 create mode 100644 picol.h

diff --git a/picol.c b/picol.c
index 77eaff7..c7be362 100644
--- a/picol.c
+++ b/picol.c
@@ -27,8 +27,8 @@
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
+#include "picol.h"
 
-enum {PICOL_OK, PICOL_ERR, PICOL_RETURN, PICOL_BREAK, PICOL_CONTINUE};
 enum {PT_ESC,PT_STR,PT_CMD,PT_VAR,PT_SEP,PT_EOL,PT_EOF};
 
 struct picolParser {
@@ -41,33 +41,6 @@ struct picolParser {
     int insidequote; /* True if inside " " */
 };
 
-struct picolVar {
-    char *name, *val;
-    struct picolVar *next;
-};
-
-struct picolInterp; /* forward declaration */
-typedef int (*picolCmdFunc)(struct picolInterp *i, int argc, char **argv, void *privdata);
-
-struct picolCmd {
-    char *name;
-    picolCmdFunc func;
-    void *privdata;
-    struct picolCmd *next;
-};
-
-struct picolCallFrame {
-    struct picolVar *vars;
-    struct picolCallFrame *parent; /* parent is NULL at top level */
-};
-
-struct picolInterp {
-    int level; /* Level of nesting */
-    struct picolCallFrame *callframe;
-    struct picolCmd *commands;
-    char *result;
-};
-
 static void picolInitParser(struct picolParser *p, const char *text) {
     p->text = p->p = text;
     p->len = strlen(text);
diff --git a/picol.h b/picol.h
new file mode 100644
index 0000000..268539c
--- /dev/null
+++ b/picol.h
@@ -0,0 +1,77 @@
+/* Tcl in ~ 500 lines of code.
+ *
+ * Copyright (c) 2007-2016, Salvatore Sanfilippo <antirez at gmail dot com>
+ * All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions are met:
+ *
+ *   * Redistributions of source code must retain the above copyright notice,
+ *     this list of conditions and the following disclaimer.
+ *   * Redistributions in binary form must reproduce the above copyright
+ *     notice, this list of conditions and the following disclaimer in the
+ *     documentation and/or other materials provided with the distribution.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
+ * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
+ * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
+ * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
+ * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
+ * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
+ * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
+ * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
+ * POSSIBILITY OF SUCH DAMAGE.
+ */
+
+#ifndef PICOL_H
+#define PICOL_H
+
+#ifdef __cplusplus
+extern "C" {
+#endif
+
+enum {PICOL_OK, PICOL_ERR, PICOL_RETURN, PICOL_BREAK, PICOL_CONTINUE};
+
+struct picolVar {
+    char *name, *val;
+    struct picolVar *next;
+};
+
+struct picolInterp; /* forward declaration */
+typedef int (*picolCmdFunc)(struct picolInterp *i, int argc, char **argv, void *privdata);
+
+struct picolCmd {
+    char *name;
+    picolCmdFunc func;
+    void *privdata;
+    struct picolCmd *next;
+};
+
+struct picolCallFrame {
+    struct picolVar *vars;
+    struct picolCallFrame *parent; /* parent is NULL at top level */
+};
+
+struct picolInterp {
+    int level; /* Level of nesting */
+    struct picolCallFrame *callframe;
+    struct picolCmd *commands;
+    char *result;
+};
+
+extern void picolInitInterp(struct picolInterp *i);
+extern void picolSetResult(struct picolInterp *i, const char *s);
+extern struct picolVar *picolGetVar(struct picolInterp *i, const char *name);
+extern int picolSetVar(struct picolInterp *i, const char *name, const char *val);
+extern int picolRegisterCommand(struct picolInterp *i, const char *name, picolCmdFunc f, void *privdata);
+extern int picolEval(struct picolInterp *i, const char *t);
+extern int picolArityErr(struct picolInterp *i, const char *name);
+extern void picolRegisterCoreCommands(struct picolInterp *i);
+
+#ifdef __cplusplus
+}
+#endif
+
+#endif /* PICOL_H */
-- 
2.45.2

